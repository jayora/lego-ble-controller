<!DOCTYPE html>
<html>
<head>
	<title>Lego BLE Controller</title>
	<style>
		body{
			font-family: Helvetica;
			text-align:center;
		}
		ol{
			width:400px;
			text-align:left;
			margin:0 auto;
		}
	</style>
</head>
<body>
	<button id="connect">Connect</button>
	<input id="m1" type="range" min="-255" max="255" step="1" />
	<script>
		//BLE
		let service        	= '0000ffe0-0000-1000-8000-00805f9b34fb';
		let characteristic 	= '0000ffe1-0000-1000-8000-00805f9b34fb';
		let byteLength		= 20;
		let characteristicInstance;

		window.onload = () => {
			document.getElementById('connect').onclick = connectBLE;
			document.getElementById('m1').onchange = updateSpeed;
		}

		function connectBLE(){
			//BLE setup. Connect and get service/characteristic notifications
			navigator.bluetooth.requestDevice({ filters: [{ services: [service] }] })
			.then(device => device.gatt.connect())
			.then(server => server.getPrimaryService(service))
			.then(service => service.getCharacteristic(characteristic))
			.then(characteristic => {
				characteristicInstance = characteristic;
  				return characteristic.writeValue(str2ab("0#0#0#0"));
			})
			.catch(error => { console.log(error); });
		}

		function str2ab(str){
			var buf = new ArrayBuffer(str.length*2); // 2 bytes for each char
			var bufView = new Uint8Array(buf);
			for (var i=0, strLen=str.length; i < strLen; i++) {
				bufView[i] = str.charCodeAt(i);
			}
			return buf;
		}

		function writeChar(str){
			characteristicInstance.writeValue(str2ab(str));
		}

		function updateSpeed(){
			console.log(this.value);
			let value = new Uint8Array([100]);
			characteristicInstance.writeValue(value);
		}
	</script>
</body>
</html>